<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系統設定 - SRS 學習系統</title>
  
  <!-- 字體 -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- 共用樣式 -->
  <link rel="stylesheet" href="/shared/css/common.css">
  
  <!-- 頁面專用樣式 -->
  <style>
    /* 設定頁面樣式 */
    .settings-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .settings-tabs {
      display: flex;
      background: var(--white);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-light);
      margin-bottom: var(--spacing-xl);
      overflow: hidden;
    }

    .settings-tab {
      flex: 1;
      padding: var(--spacing-lg);
      text-align: center;
      background: var(--gray-100);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      border: none;
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .settings-tab.active {
      background: var(--primary);
      color: var(--white);
    }

    .settings-tab:hover:not(.active) {
      background: var(--gray-200);
    }

    .settings-content {
      background: var(--white);
      border-radius: var(--radius-large);
      box-shadow: var(--shadow-light);
      padding: var(--spacing-xl);
    }

    .settings-section {
      display: none;
    }

    .settings-section.active {
      display: block;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }

    .form-actions {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--gray-200);
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }



    /* 響應式設計 */
    @media (max-width: 768px) {
      .settings-tabs {
        flex-direction: column;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- 頁面內容將由JavaScript動態生成 -->

  <!-- 配置文件 -->
  <script src="../shared/js/config.js"></script>
  
  <!-- 共用腳本 -->
  <script src="/shared/js/common.js"></script>
  <script src="/shared/components/navigation.js"></script>
  
  <!-- 頁面專用腳本 -->
  <script>
    // 當前活動的標籤
    let activeTab = 'profile';

    /**
     * 切換設定標籤
     */
    window.switchTab = function(tabName) {
      // 更新標籤狀態
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

      // 更新內容區域
      document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${tabName}-section`).classList.add('active');

      activeTab = tabName;

      // 載入對應的資料
      loadTabData(tabName);
    }

    /**
     * 載入標籤資料
     */
    async function loadTabData(tabName) {
      try {
        switch (tabName) {
          case 'profile':
            await loadProfileData();
            break;
          case 'preferences':
            await loadPreferencesData();
            break;
          case 'notifications':
            await loadNotificationsData();
            break;
        }
      } catch (error) {
        console.error(`載入${tabName}資料失敗:`, error);
        showAlert('載入資料時發生錯誤', 'error');
      }
    }

    /**
     * 載入個人資料
     */
    async function loadProfileData() {
      const response = await apiRequest('/api/settings/profile');
      if (response && response.ok) {
        const data = await response.json();
        const profile = data.data;

        document.getElementById('profile-username').value = profile.username || '';
        document.getElementById('profile-email').value = profile.email || '';
        document.getElementById('profile-full-name').value = profile.full_name || '';
        document.getElementById('profile-phone').value = profile.phone || '';
      }
    }

    /**
     * 載入學習偏好
     */
    async function loadPreferencesData() {
      const response = await apiRequest('/api/settings/preferences');
      if (response && response.ok) {
        const data = await response.json();
        const prefs = data.data;

        document.getElementById('practice-mode').value = prefs.default_practice_mode || 'mixed';
        document.getElementById('review-strategy').value = prefs.review_strategy || 'spaced';
        document.getElementById('daily-limit').value = prefs.daily_new_words_limit || 20;
        document.getElementById('difficulty-auto').checked = prefs.difficulty_adjustment === 'auto';
      }
    }

    /**
     * 載入通知設定
     */
    async function loadNotificationsData() {
      const response = await apiRequest('/api/settings/notifications');
      if (response && response.ok) {
        const data = await response.json();
        const notifs = data.data || [];

        // 將通知設定陣列轉換為前端使用的格式
        const notificationMap = {};
        notifs.forEach(notif => {
          notificationMap[notif.notification_type] = notif.is_enabled;
        });

        document.getElementById('study-reminders').checked = notificationMap['daily_reminder'] || false;
        document.getElementById('review-reminders').checked = notificationMap['review_due'] || false;
        document.getElementById('achievement-notifications').checked = notificationMap['goal_reminder'] || false;
      }
    }


    /**
     * 儲存個人資料
     */
    async function saveProfile() {
      const formData = {
        username: document.getElementById('profile-username').value,
        email: document.getElementById('profile-email').value,
        full_name: document.getElementById('profile-full-name').value,
        phone: document.getElementById('profile-phone').value
      };

      try {
        const response = await apiRequest('/api/settings/profile', {
          method: 'PUT',
          body: JSON.stringify(formData)
        });

        if (response && response.ok) {
          showAlert('個人資料已更新', 'success');
          // 重新載入當前標籤的資料以顯示最新資訊
          loadTabData('profile');
        } else {
          throw new Error('更新失敗');
        }
      } catch (error) {
        console.error('更新個人資料失敗:', error);
        showAlert('更新個人資料時發生錯誤', 'error');
      }
    }

    /**
     * 儲存學習偏好
     */
    async function savePreferences() {
      const formData = {
        default_practice_mode: document.getElementById('practice-mode').value,
        review_strategy: document.getElementById('review-strategy').value,
        daily_new_words_limit: parseInt(document.getElementById('daily-limit').value),
        difficulty_adjustment: document.getElementById('difficulty-auto').checked ? 'auto' : 'manual'
      };

      try {
        const response = await apiRequest('/api/settings/preferences', {
          method: 'PUT',
          body: JSON.stringify(formData)
        });

        if (response && response.ok) {
          showAlert('學習偏好已更新', 'success');
        } else {
          throw new Error('更新失敗');
        }
      } catch (error) {
        console.error('更新學習偏好失敗:', error);
        showAlert('更新學習偏好時發生錯誤', 'error');
      }
    }

    /**
     * 儲存通知設定
     */
    async function saveNotifications() {
      const formData = {
        daily_reminder: document.getElementById('study-reminders').checked,
        review_due: document.getElementById('review-reminders').checked,
        goal_reminder: document.getElementById('achievement-notifications').checked
      };

      try {
        const response = await apiRequest('/api/settings/notifications', {
          method: 'PUT',
          body: JSON.stringify(formData)
        });

        if (response && response.ok) {
          showAlert('通知設定已更新', 'success');
        } else {
          throw new Error('更新失敗');
        }
      } catch (error) {
        console.error('更新通知設定失敗:', error);
        showAlert('更新通知設定時發生錯誤', 'error');
      }
    }


    /**
     * 初始化系統設定頁面
     */
    function initializeSettings() {
      const contentArea = initializeNavigation('settings', '系統設定');
      
      contentArea.innerHTML = `
        <div class="settings-container">
          <!-- 設定標籤 -->
          <div class="settings-tabs">
            <button class="settings-tab active" data-tab="profile">個人資料</button>
            <button class="settings-tab" data-tab="preferences">學習偏好</button>
            <button class="settings-tab" data-tab="notifications">通知設定</button>
          </div>

          <!-- 設定內容 -->
          <div class="settings-content">
            <!-- 個人資料 -->
            <div id="profile-section" class="settings-section active">
              <h3 class="mb-4">個人資料</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">使用者名稱</label>
                  <input type="text" id="profile-username" class="form-input" readonly>
                </div>
                <div class="form-group">
                  <label class="form-label">電子郵件</label>
                  <input type="email" id="profile-email" class="form-input">
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">真實姓名</label>
                  <input type="text" id="profile-full-name" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">電話號碼</label>
                  <input type="tel" id="profile-phone" class="form-input">
                </div>
              </div>
              
              <div class="form-actions">
                <button class="btn btn-primary" onclick="saveProfile()">儲存變更</button>
              </div>
            </div>

            <!-- 學習偏好 -->
            <div id="preferences-section" class="settings-section">
              <h3 class="mb-4">學習偏好</h3>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">練習模式</label>
                  <select id="practice-mode" class="form-input">
                    <option value="mixed">混合模式</option>
                    <option value="new_words">新單字練習</option>
                    <option value="review">複習模式</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">複習策略</label>
                  <select id="review-strategy" class="form-input">
                    <option value="spaced">間隔重複</option>
                    <option value="frequent">頻繁複習</option>
                    <option value="random">隨機複習</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label class="form-label">每日學習限制</label>
                <input type="number" id="daily-limit" class="form-input" min="10" max="200" step="10">
              </div>
              
              <div class="form-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="difficulty-auto">
                  <label for="difficulty-auto">自動調整難度</label>
                </div>
              </div>
              
              <div class="form-actions">
                <button class="btn btn-primary" onclick="savePreferences()">儲存變更</button>
              </div>
            </div>

            <!-- 通知設定 -->
            <div id="notifications-section" class="settings-section">
              <h3 class="mb-4">通知設定</h3>
              
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="study-reminders">
                  <label for="study-reminders">學習提醒</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="review-reminders">
                  <label for="review-reminders">複習提醒</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="achievement-notifications">
                  <label for="achievement-notifications">成就通知</label>
                </div>
              </div>
              
              <div class="form-actions">
                <button class="btn btn-primary" onclick="saveNotifications()">儲存變更</button>
              </div>
            </div>

          </div>
        </div>
      `;

      // 載入初始資料
      loadTabData('profile');
      
      // 修復登出按鈕事件綁定
      setTimeout(() => {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function() {
            if (typeof logout === 'function') {
              logout();
            } else {
              localStorage.removeItem('admin_token');
              window.location.href = '/admin.html';
            }
          });
        }
        
        // 綁定設定標籤點擊事件
        document.querySelectorAll('.settings-tab').forEach(tab => {
          tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
          });
        });
      }, 200);
    }


    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 檢查認證狀態
      if (!isAuthenticated()) {
        redirectToLogin();
        return;
      }
      
      setTimeout(initializeSettings, 100);
    });
  </script>

</body>
</html>